<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Timbre Industrial</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Advertencia de conexi√≥n */
        .connection-warning {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 30px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            animation: pulse-warning 2s infinite;
        }

        .connection-warning.hidden {
            display: none;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .status-bar {
            background: #ecf0f1;
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            border-bottom: 1px solid #bdc3c7;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #27ae60;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .connection-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .schedule-item {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .info-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .schedule-info {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .status-bar {
                padding: 15px 20px;
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #219a52;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .control-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
        }

        .modal-close:hover {
            color: #2c3e50;
        }

        .modal-body {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .connection-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
        }

        @media (max-width: 600px) {
            .connection-form {
                grid-template-columns: 1fr;
            }
        }

        .disabled-overlay {
            position: relative;
        }

        .disabled-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10;
            border-radius: 8px;
        }

        .schedule-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Control de Timbre Industrial</h1>
            <p>Plataforma de Gesti√≥n para F√°brica de Galvanizado</p>
        </div>

        <!-- Advertencia de conexi√≥n -->
        <div class="connection-warning" id="connectionWarning">
            ‚ö†Ô∏è IMPORTANTE: Con√©ctese al ESP32 antes de configurar horarios. Los horarios solo se pueden gestionar cuando est√© conectado al sistema.
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span>ESP32: <span id="connectionStatus">Desconectado</span></span>
            </div>
            <div class="status-item">
                <span>Hora Actual: <span id="currentTime">--:--:--</span></span>
            </div>
            <div class="status-item">
                <span>Fecha: <span id="currentDate">----/--/--</span></span>
            </div>
            <div class="status-item">
                <span>√öltima Sync NTP: <span id="lastNtpSync">--</span></span>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2 class="section-title">üîó Conexi√≥n al Sistema</h2>
                <div class="connection-panel">
                    <div class="connection-form">
                        <div class="form-group">
                            <label class="form-label" for="esp32Ip">Direcci√≥n IP del ESP32:</label>
                            <input type="text" id="esp32Ip" class="form-input" placeholder="192.168.1.100" value="192.168.1.100">
                        </div>
                        <button class="btn btn-primary" onclick="connectToESP32()">
                            <span id="connectText">Conectar</span>
                            <div id="connectSpinner" class="loading-spinner" style="display:none; margin-left: 8px;"></div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section" id="scheduleSection">
                <h2 class="section-title">‚è∞ Configuraci√≥n de Horarios</h2>
                <div class="schedule-counter">
                    <div>
                        <strong>Horarios Configurados: <span id="scheduleCount">0</span>/40</strong>
                        <br>
                        <small style="color: #7f8c8d;">Los horarios se gestionan directamente desde el ESP32</small>
                    </div>
                    <button class="btn btn-success" id="addScheduleBtn" onclick="showAddScheduleModal()" disabled>
                        Agregar Nuevo Horario
                    </button>
                </div>
                <div id="scheduleList">
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">üìã</p>
                        <p>Con√©ctese al ESP32 para ver y gestionar los horarios programados</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">üéõÔ∏è Panel de Control Manual</h2>
                <div class="control-grid">
                    <div class="control-section">
                        <h3>Pruebas Individuales - Timbre 1</h3>
                        <button class="btn btn-secondary" onclick="testBell('continuo', '1')" style="width: 100%; margin-bottom: 8px;" disabled>Continuo</button>
                        <button class="btn btn-secondary" onclick="testBell('intermitente', '1')" style="width: 100%; margin-bottom: 8px;" disabled>Intermitente (2x)</button>
                        <button class="btn btn-secondary" onclick="testBell('triple', '1')" style="width: 100%;" disabled>Triple (3x)</button>
                    </div>
                    
                    <div class="control-section">
                        <h3>Pruebas Individuales - Timbre 2</h3>
                        <button class="btn btn-secondary" onclick="testBell('continuo', '2')" style="width: 100%; margin-bottom: 8px;" disabled>Continuo</button>
                        <button class="btn btn-secondary" onclick="testBell('intermitente', '2')" style="width: 100%; margin-bottom: 8px;" disabled>Intermitente (2x)</button>
                        <button class="btn btn-secondary" onclick="testBell('triple', '2')" style="width: 100%;" disabled>Triple (3x)</button>
                    </div>
                    
                    <div class="control-section">
                        <h3>Controles del Sistema</h3>
                        <button class="btn btn-primary" onclick="testBell('continuo', 'both')" style="width: 100%; margin-bottom: 8px;" disabled>Ambos Timbres</button>
                        <button class="btn btn-warning" onclick="syncTime()" style="width: 100%; margin-bottom: 8px;" disabled>Sincronizar Hora Manual</button>
                        <button class="btn btn-warning" onclick="forceNtpSync()" style="width: 100%; margin-bottom: 8px;" disabled>Sincronizar con NTP</button>
                        <button class="btn btn-success" onclick="sendSchedulesToESP32()" style="width: 100%; margin-bottom: 8px;" disabled>Enviar Configuraci√≥n</button>
                        <button class="btn btn-danger" onclick="clearLocalStorage()" style="width: 100%;">Restablecer IP</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Estado -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Estado del Sistema</h3>
                <button class="modal-close" onclick="closeModal('statusModal')">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                Procesando...
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('statusModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Horario -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Horario</h3>
                <button class="modal-close" onclick="closeModal('addScheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre del Horario:</label>
                    <input type="text" id="newScheduleName" class="form-input" placeholder="Ej: Entrada Turno Ma√±ana">
                </div>
                <div class="form-group">
                    <label class="form-label">Hora:</label>
                    <input type="time" id="newScheduleTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Duraci√≥n (segundos):</label>
                    <input type="number" id="newScheduleDuration" class="form-input" min="1" max="30" value="3">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Timbre:</label>
                    <select id="newScheduleType" class="form-select">
                        <option value="continuo">Continuo</option>
                        <option value="intermitente">Intermitente (2x)</option>
                        <option value="triple">Triple (3x)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Rel√©(s) a Activar:</label>
                    <select id="newScheduleRelay" class="form-select">
                        <option value="1">Timbre 1</option>
                        <option value="2">Timbre 2</option>
                        <option value="both">Ambos Timbres</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addScheduleModal')">Cancelar</button>
                <button class="btn btn-success" onclick="createNewSchedule()">Crear Horario</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let schedules = [];
        let esp32Ip = '192.168.1.100';
        let isConnected = false;

        // ==================== GESTI√ìN DE ALMACENAMIENTO LOCAL ====================
        function saveIpToStorage() {
            try {
                localStorage.setItem('timbre_esp32_ip', esp32Ip);
                console.log('IP guardada en localStorage');
            } catch (error) {
                console.error('Error guardando IP:', error);
            }
        }

        function loadIpFromStorage() {
            try {
                const savedIp = localStorage.getItem('timbre_esp32_ip');
                if (savedIp) {
                    esp32Ip = savedIp;
                    document.getElementById('esp32Ip').value = savedIp;
                    console.log('IP cargada desde localStorage:', savedIp);
                }
            } catch (error) {
                console.error('Error cargando IP:', error);
            }
        }

        function clearLocalStorage() {
            if (confirm('¬øEst√° seguro de que desea restablecer la IP guardada?')) {
                localStorage.removeItem('timbre_esp32_ip');
                document.getElementById('esp32Ip').value = '192.168.1.100';
                esp32Ip = '192.168.1.100';
                showModal('IP Restablecida', 'La direcci√≥n IP ha sido restablecida a los valores por defecto.', 'success');
            }
        }

        // ==================== ACTUALIZACI√ìN DE TIEMPO ====================
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            document.getElementById('currentDate').textContent = now.toLocaleDateString();
        }

        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        // ==================== GESTI√ìN DE MODALES ====================
        function showModal(title, message, type = 'info') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = message;
            document.getElementById('statusModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAddScheduleModal() {
            if (!isConnected) {
                showModal('Error', 'Debe conectarse al ESP32 antes de agregar horarios.', 'error');
                return;
            }

            if (schedules.length >= 40) {
                showModal('L√≠mite Alcanzado', 'No se pueden agregar m√°s de 40 horarios. Elimine algunos horarios existentes.', 'error');
                return;
            }

            // Limpiar formulario
            document.getElementById('newScheduleName').value = '';
            document.getElementById('newScheduleTime').value = '08:00';
            document.getElementById('newScheduleDuration').value = '3';
            document.getElementById('newScheduleType').value = 'continuo';
            document.getElementById('newScheduleRelay').value = '1';
            
            document.getElementById('addScheduleModal').classList.add('show');
        }

        // ==================== GESTI√ìN DE CONEXI√ìN ESP32 ====================
        async function connectToESP32() {
            esp32Ip = document.getElementById('esp32Ip').value;
            
            const connectBtn = document.querySelector('#connectText').parentElement;
            const connectText = document.getElementById('connectText');
            const connectSpinner = document.getElementById('connectSpinner');
            
            connectText.textContent = 'Conectando...';
            connectSpinner.style.display = 'inline-block';
            connectBtn.disabled = true;
            
            try {
                const response = await fetch(`http://${esp32Ip}/status`);
                if (response.ok) {
                    const data = await response.json();
                    isConnected = true;
                    updateConnectionStatus();
                    updateNtpStatus(data);
                    saveIpToStorage();
                    showModal('Conexi√≥n Exitosa', `Conectado correctamente al ESP32 en la direcci√≥n ${esp32Ip}`, 'success');
                    await loadSchedulesFromESP32();
                } else {
                    throw new Error('No se pudo conectar');
                }
            } catch (error) {
                isConnected = false;
                updateConnectionStatus();
                showModal('Error de Conexi√≥n', 'No se pudo conectar al ESP32. Verifique que:<br><br>‚Ä¢ La direcci√≥n IP sea correcta<br>‚Ä¢ El ESP32 est√© encendido<br>‚Ä¢ Ambos dispositivos est√©n en la misma red WiFi', 'error');
            } finally {
                connectText.textContent = 'Conectar';
                connectSpinner.style.display = 'none';
                connectBtn.disabled = false;
            }
        }

        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            const warning = document.getElementById('connectionWarning');
            const addBtn = document.getElementById('addScheduleBtn');
            
            // Obtener todos los botones de control
            const controlButtons = document.querySelectorAll('.control-section .btn:not(.btn-danger)');
            
            if (isConnected) {
                indicator.classList.add('connected');
                status.textContent = 'Conectado';
                warning.classList.add('hidden');
                addBtn.disabled = false;
                
                // Habilitar botones de control
                controlButtons.forEach(btn => btn.disabled = false);
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'Desconectado';
                warning.classList.remove('hidden');
                addBtn.disabled = true;
                
                // Deshabilitar botones de control
                controlButtons.forEach(btn => btn.disabled = true);
            }
        }

        function updateNtpStatus(data) {
            const ntpElement = document.getElementById('lastNtpSync');
            if (data.hours_since_ntp_sync !== undefined) {
                const hours = data.hours_since_ntp_sync;
                if (hours < 1) {
                    ntpElement.textContent = 'Reciente';
                    ntpElement.style.color = '#27ae60';
                } else if (hours < 24) {
                    ntpElement.textContent = `Hace ${hours}h`;
                    ntpElement.style.color = '#f39c12';
                } else {
                    ntpElement.textContent = `Hace ${hours}h`;
                    ntpElement.style.color = '#e74c3c';
                }
            } else {
                ntpElement.textContent = 'No disponible';
                ntpElement.style.color = '#7f8c8d';
            }
        }

        // ==================== GESTI√ìN DE HORARIOS ====================
        async function createNewSchedule() {
            const name = document.getElementById('newScheduleName').value.trim();
            const time = document.getElementById('newScheduleTime').value;
            const duration = parseInt(document.getElementById('newScheduleDuration').value);
            const type = document.getElementById('newScheduleType').value;
            const relay = document.getElementById('newScheduleRelay').value;

            if (!name) {
                showModal('Error', 'Debe ingresar un nombre para el horario.', 'error');
                return;
            }

            if (!time) {
                showModal('Error', 'Debe seleccionar una hora para el horario.', 'error');
                return;
            }

            const newSchedule = {
                id: Date.now(),
                name: name,
                time: time,
                duration: duration,
                type: type,
                relay: relay,
                enabled: true
            };

            try {
                // Enviar directamente al ESP32
                const response = await fetch(`http://${esp32Ip}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedules: [...schedules, newSchedule] })
                });

                if (response.ok) {
                    schedules.push(newSchedule);
                    renderSchedules();
                    closeModal('addScheduleModal');
                    showModal('Horario Creado', `El horario "${name}" ha sido creado y enviado al ESP32 exitosamente.`, 'success');
                } else {
                    throw new Error('Error al crear horario en ESP32');
                }
            } catch (error) {
                showModal('Error', 'No se pudo crear el horario en el ESP32. Verifique la conexi√≥n.', 'error');
            }
        }

        async function deleteSchedule(id) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este horario?')) {
                return;
            }

            try {
                // Eliminar del array local
                schedules = schedules.filter(s => s.id !== id);
                
                // Enviar array actualizado al ESP32
                const response = await fetch(`http://${esp32Ip}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedules })
                });

                if (response.ok) {
                    renderSchedules();
                    showModal('Horario Eliminado', 'El horario ha sido eliminado exitosamente del ESP32.', 'success');
                } else {
                    throw new Error('Error al eliminar horario del ESP32');
                }
            } catch (error) {
                showModal('Error', 'No se pudo eliminar el horario del ESP32. Verifique la conexi√≥n.', 'error');
                // Recargar horarios del ESP32 para sincronizar
                await loadSchedulesFromESP32();
            }
        }

        function renderSchedules() {
            const container = document.getElementById('scheduleList');
            container.innerHTML = '';

            // Actualizar contador
            document.getElementById('scheduleCount').textContent = schedules.length;

            if (schedules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">üìã</p>
                        <p>No hay horarios configurados</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Agregue un nuevo horario para comenzar</p>
                    </div>
                `;
                return;
            }

            schedules.forEach((schedule, index) => {
                const typeText = schedule.type === 'continuo' ? 'Continuo' : 
                               schedule.type === 'intermitente' ? 'Intermitente (2x)' : 'Triple (3x)';
                const relayText = schedule.relay === '1' ? 'Timbre 1' : 
                                schedule.relay === '2' ? 'Timbre 2' : 'Ambos Timbres';
                
                const div = document.createElement('div');
                div.className = 'schedule-item';
                div.innerHTML = `
                    <div class="schedule-header">
                        <h4 style="color: #2c3e50; margin: 0;">${schedule.name}</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="padding: 4px 8px; background: ${schedule.enabled ? '#27ae60' : '#95a5a6'}; color: white; border-radius: 4px; font-size: 0.8rem;">
                                ${schedule.enabled ? 'ACTIVO' : 'INACTIVO'}
                            </span>
                            <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})" style="padding: 6px 12px; min-height: auto;">
                                Eliminar
                            </button>
                        </div>
                    </div>
                    <div class="schedule-info">
                        <div class="info-item">
                            <div class="info-label">Hora de Activaci√≥n</div>
                            <div class="info-value">‚è∞ ${schedule.time}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Duraci√≥n</div>
                            <div class="info-value">‚è±Ô∏è ${schedule.duration} segundos</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Tipo de Timbre</div>
                            <div class="info-value">üîî ${typeText}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Rel√©(s) Activos</div>
                            <div class="info-value">üì° ${relayText}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function loadSchedulesFromESP32() {
            try {
                const response = await fetch(`http://${esp32Ip}/schedules`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.schedules) {
                        schedules = data.schedules;
                        renderSchedules();
                        console.log(`${schedules.length} horarios cargados desde ESP32`);
                    }
                }
            } catch (error) {
                console.error('Error cargando horarios desde ESP32:', error);
            }
        }

        // ==================== CONTROL MANUAL DE TIMBRES ====================
        async function testBell(type = 'continuo', relay = '1') {
            if (!isConnected) {
                showModal('Error', 'Debe conectarse al ESP32 antes de realizar pruebas.', 'error');
                return;
            }

            const relayText = relay === '1' ? 'Timbre 1' : relay === '2' ? 'Timbre 2' : 'Ambos Timbres';
            const typeText = type === 'continuo' ? 'continuo' : type === 'intermitente' ? 'intermitente (2x)' : 'triple (3x)';

            try {
                const response = await fetch(`http://${esp32Ip}/test-bell`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, duration: 3, relay: relay })
                });
                
                if (response.ok) {
                    showModal('Prueba Ejecutada', `${relayText} activado en modo ${typeText} por 3 segundos.`, 'success');
                } else {
                    throw new Error('Error al activar timbre');
                }
            } catch (error) {
                showModal('Error de Comunicaci√≥n', 'No se pudo comunicar con el ESP32 para ejecutar la prueba.', 'error');
            }
        }

        // ==================== SINCRONIZACI√ìN DE TIEMPO ====================
        async function syncTime() {
            if (!isConnected) {
                showModal('Error', 'Debe conectarse al ESP32 antes de sincronizar la hora.', 'error');
                return;
            }

            try {
                const now = new Date();
                const timeData = {
                    year: now.getFullYear(),
                    month: now.getMonth() + 1,
                    day: now.getDate(),
                    hour: now.getHours(),
                    minute: now.getMinutes(),
                    second: now.getSeconds()
                };

                const response = await fetch(`http://${esp32Ip}/sync-time`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(timeData)
                });

                if (response.ok) {
                    showModal('Sincronizaci√≥n Exitosa', 'La hora del ESP32 ha sido sincronizada correctamente con la hora del sistema.', 'success');
                    setTimeout(checkNtpStatus, 1000);
                } else {
                    throw new Error('Error al sincronizar');
                }
            } catch (error) {
                showModal('Error de Sincronizaci√≥n', 'No se pudo sincronizar la hora con el ESP32.', 'error');
            }
        }

        async function forceNtpSync() {
            if (!isConnected) {
                showModal('Error', 'Debe conectarse al ESP32 antes de sincronizar con NTP.', 'error');
                return;
            }

            try {
                const response = await fetch(`http://${esp32Ip}/force-ntp-sync`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showModal('Sincronizaci√≥n NTP Exitosa', 'El ESP32 se ha sincronizado correctamente con los servidores NTP. La hora es ahora precisa y se mantendr√° autom√°ticamente cada 24 horas.', 'success');
                    setTimeout(checkNtpStatus, 2000);
                } else {
                    throw new Error('Error al sincronizar con NTP');
                }
            } catch (error) {
                showModal('Error de Sincronizaci√≥n NTP', 'No se pudo sincronizar con los servidores NTP. Verifique que el ESP32 tenga conexi√≥n a internet.', 'error');
            }
        }

        async function checkNtpStatus() {
            if (!isConnected) return;
            
            try {
                const response = await fetch(`http://${esp32Ip}/status`);
                if (response.ok) {
                    const data = await response.json();
                    updateNtpStatus(data);
                }
            } catch (error) {
                console.error('Error verificando estado NTP:', error);
            }
        }

        // ==================== ENV√çO DE CONFIGURACI√ìN ====================
        async function sendSchedulesToESP32() {
            if (!isConnected) {
                showModal('Error', 'Debe conectarse al ESP32 antes de enviar la configuraci√≥n.', 'error');
                return;
            }

            if (schedules.length === 0) {
                showModal('Advertencia', 'No hay horarios configurados para enviar.', 'warning');
                return;
            }

            try {
                const response = await fetch(`http://${esp32Ip}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedules })
                });

                if (response.ok) {
                    showModal('Configuraci√≥n Enviada', `Se han enviado ${schedules.length} horarios al ESP32. La configuraci√≥n se ha guardado correctamente y estar√° activa de forma permanente.`, 'success');
                } else {
                    throw new Error('Error al enviar configuraci√≥n');
                }
            } catch (error) {
                showModal('Error de Env√≠o', 'No se pudo enviar la configuraci√≥n al ESP32. Verifique la conexi√≥n.', 'error');
            }
        }

        // ==================== EVENTOS Y INICIALIZACI√ìN ====================
        window.onclick = function(event) {
            const statusModal = document.getElementById('statusModal');
            const addModal = document.getElementById('addScheduleModal');
            if (event.target === statusModal) {
                closeModal('statusModal');
            }
            if (event.target === addModal) {
                closeModal('addScheduleModal');
            }
        }

        // Actualizar IP cuando cambie el input
        document.getElementById('esp32Ip').addEventListener('change', function() {
            esp32Ip = this.value;
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadIpFromStorage();
            updateConnectionStatus();
            renderSchedules();
        });

        // Verificar estado NTP cada 5 minutos si est√° conectado
        setInterval(() => {
            if (isConnected) {
                checkNtpStatus();
            }
        }, 5 * 60 * 1000);

        // Cargar IP al inicio
        loadIpFromStorage();
        updateConnectionStatus();
        renderSchedules();
    </script>
</body>
</html>